#!/usr/bin/env node
const path = require('path');
const fs = require('fs');
const execFile = require('child_process').execFile;
const exec = require('child_process').exec;

const hookName = path.basename(__filename);
const userHooks = path.join(__dirname, '../../hooks')
const hookFile = require(path.join(__dirname, '../../hookman.json'));
const hookExecutable = path.join(userHooks, hookName) 
const hookExecutableExists = fs.existsSync(hookExecutable); 
const hookScript = hookFile[hookName]; 

if (hookScript) {
  const child = exec(hookScript, function (error, stdout, stderr) {
    
    if (stderr) {
      console.log(stderr);
      process.exit(1);
    }

    if (stdout) {
      console.log(stdout);
    }

    if (error) {
      console.error('An error occured, please make sure your hookfile contains a valid command.');
      process.exit(1); 
    }

    process.exit(0);    
  });
}

if (hookExecutableExists) {
  const child = execFile(hookExecutable, [], function (error, stdout, stderr) {
    
    if (stderr) {
      console.log(stderr);
      process.exit(1);
    }

    if (stdout) {
      console.log(stdout);
    }

    if (error) {
      console.error('An error occured, please make sure your hook files have the correct permissions.');
      process.exit(1); 
    }

    process.exit(0);    
  });
}
